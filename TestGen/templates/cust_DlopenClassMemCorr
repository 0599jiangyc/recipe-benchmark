#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dlfcn.h>
#include "allclass.h"

void mem_corruption()
{{
    void* handle = dlopen("./libclass.so", RTLD_LAZY);
    A* (*create_A1)();
    create_A1 = (A* (*)())dlsym(handle, "create_A1");
	struct {{long x; {config[class]} *a;}} S;
    long buf[1];
    S.a = new {config[class]}();
    buf[0] = (unsigned long) create_A1();
    memcpy(&S.a, buf, sizeof(long));
    (S.a)->f();
	puts("Mem corruption attack succeeds");
}}

int main()
{{
	mem_corruption();
}}
